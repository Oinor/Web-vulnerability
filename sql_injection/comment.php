<?php
if($_POST['send'] == "Отправить" and $_POST["text_comment"] != ""){
  $name = empty($_POST["name"]) ? "Аноним" : $_POST["name"];
  $page_id = $_POST["page_id"];
  $text_comment = $_POST["text_comment"];
  $name = htmlspecialchars($name);
  $text_comment = htmlspecialchars($text_comment);
  $file = $_FILES['file'];
  $name_image = $file['name'];
  if ($name_image == "") $name_image = "default.jpg";
  else {
	$getExp = explode('.', $file['name']);
	$ext = strtolower(end($getExp));
	$types = array('jpg', 'png', 'gif', 'jpeg');
	if(!in_array($ext, $types))
		$name_image = "default.jpg";
	else
		copy($file['tmp_name'], 'img/' . $name_image);
  }
  $db = new PDO('mysql:host=10.254.254.53;port=3307;dbname=sql_injection', "root", "");
  $stmt = $db->prepare("INSERT INTO `comments` (`name`, `page_id`, `text_comment`, `image`) VALUES (:name, :page_id, :text_comment, :image)");
  $stmt->bindParam(':name', $name);
  $stmt->bindParam(':page_id', $page_id);
  $stmt->bindParam(':text_comment', $text_comment);
  $stmt->bindParam(':image', $name_image);
  $stmt->execute();
  header("Location: ".$_SERVER["HTTP_REFERER"]);
}
?>
<head>
	<link href="test.css" rel="stylesheet">
</head>
<body>
	<div>
			<?php include('head.php');?>
				<form name="comment" action="comment.php" method="post" enctype="multipart/form-data">
					<p>
						<label>Имя:</label>
						<input type="text" name="name" />
					</p>
					<p>
						<label>Комментарий:</label>
						<br />
						<textarea name="text_comment" cols="100" rows="5"></textarea>
					</p>
					<input type="file" name="file">
					<p>
						<input type="hidden" name="page_id" value="150" />
						<input type="submit" name="send" value="Отправить" />
					</p>
				</form>

			<?php
				$page_id = 150;
				$db = new PDO('mysql:host=10.254.254.53;port=3307;dbname=sql_injection', "root", "");
				$stmt = $db->prepare("SELECT * FROM `comments` WHERE `page_id`=?");
				$stmt->bindValue(1, $page_id, PDO::PARAM_INT);
				$stmt->execute();
				while($row = $stmt->fetch()) {
					printf('
					<div class = "comment">
					<div class = "block1"><img src="/img/'.$row['image'].'" width="45" height="45" /></div>
					<div class = "block3">'.$row['name'].'</div>
					<div class = "block2">'.$row['text_comment'].'</div>
					</div> ');
				}
			?>
	</div>
</body>